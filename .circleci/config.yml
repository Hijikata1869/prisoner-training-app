version: 2.1

jobs:
  build:
    working_directory: ~/prisoner-training-app
    docker:
      - image: cimg/ruby:2.7.5-node
        environment:
          BUNDLER_VERSION: 2.1.4
          RAILS_ENV: 'test'
      - image: cimg/mysql:8.0
        command: mysqld --default-authentication-plugin=mysql_native_password
        environment:
          MYSQL_ROOT_PASSWORD: password
    steps:
      - checkout

      - restore_cache:
          keys:
            - gem-cache-v1-{{ checksum "Gemfile.lock" }}
            - gem-cache-v1-
      - run: bundle install --path=vendor/bundle --jobs=4 --retry=3
      - save_cache:
          key: gem-cache-v1-{{ checksum "Gemfile.lock" }}
          paths:
            - ~/prisoner-training-app/vendor/bundle

      - run: mv config/database.yml.ci config/database.yml

      - run: bundle exec rails db:create
      - run: bundle exec rails db:migrate
      - run: bundle exec rspec


workflows:
  version: 2
  build_and_test:
    jobs:
      - build
